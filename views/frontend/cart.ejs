<!DOCTYPE html>
<html lang="en">
  <!-- molla/cart.html  22 Nov 2019 09:55:06 GMT -->
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Cart</title>
    <meta name="keywords" content="HTML5 Template" />
    <meta name="description" content="Molla - Bootstrap eCommerce Template" />
    <meta name="author" content="p-themes" />
    <!-- Favicon -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="frontend/assets/images/icons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="frontend/assets/images/icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="frontend/assets/images/icons/favicon-16x16.png"
    />
    <link rel="manifest" href="frontend/assets/images/icons/site.html" />
    <link
      rel="mask-icon"
      href="frontend/assets/images/icons/safari-pinned-tab.svg"
      color="#666666"
    />
    <link rel="shortcut icon" href="frontend/assets/images/icons/favicon.ico" />
    <meta name="apple-mobile-web-app-title" content="Molla" />
    <meta name="application-name" content="Molla" />
    <meta name="msapplication-TileColor" content="#cc9966" />
    <meta
      name="msapplication-config"
      content="frontend/assets/images/icons/browserconfig.xml"
    />
    <meta name="theme-color" content="#ffffff" />
    <!-- Plugins CSS File -->
    <link rel="stylesheet" href="frontend/assets/css/bootstrap.min.css" />
    <!-- Main CSS File -->
    <link rel="stylesheet" href="frontend/assets/css/style.css" />
  </head>

  <body>
    <div class="page-wrapper">
      <%- include("./navbar.ejs") %>
      <!-- End .header -->

      <main class="main">
        <div
          class="page-header text-center"
          style="
            background-image: url('frontend/assets/images/page-header-bg.jpg');
          "
        >
          <div class="container">
            <h1 class="page-title">Shopping Cart<span>Shop</span></h1>
          </div>
          <!-- End .container -->
        </div>
        <!-- End .page-header -->
        <nav aria-label="breadcrumb" class="breadcrumb-nav">
          <div class="container">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/">Home</a></li>
              <li class="breadcrumb-item active" aria-current="page">
                Shopping Cart
              </li>
            </ol>
          </div>
          <!-- End .container -->
        </nav>
        <!-- End .breadcrumb-nav -->

        <div class="page-content">
          <div class="cart">
            <div class="container">
              <form id="check-coupon">
                <div class="row">
                  <div class="col-md-4 col-xs-12">
                    <input type="text" placeholder="Have a Coupon?" name="coupon" id="couponid" class="form-control m-0">
                  </div>
                  <div class="col-md-1 col-xs-12">
                    <button type="submit" class="btn btn-order btn-outline-primary-2 btn-block" id="cmutton">Apply</button>
                    
                  </div>
                  
                </div>
                <div class="d-flex mt-2">
                  <p id="couponresponse" class="mr-3"></p>
                  <a id="cremove" style="cursor: pointer;color:#c96;display: none;"><i class="icon-close"></i> Remove coupon</a>
                </div>
              
              </form>
              <div class="row">
                <div class="col-lg-9">
                  <form id="form-checkout" action="/checkout" method="POST">
                    <input type="hidden" name="couponcode" id="couponcode" value="">
                  <table class="table table-cart table-mobile">
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th></th>
                      </tr>
                    </thead>
                    
                      <tbody id="cartproductcontainer"></tbody>
                    
                  </table>
                </form>
                  <!-- End .table table-wishlist -->

                  <!-- End .cart-bottom -->
                </div>
                <!-- End .col-lg-9 -->
                <aside class="col-lg-3">
                  <div class="summary summary-cart">
                    <h3 class="summary-title">Cart Total</h3>
                    <!-- End .summary-title -->

                    <table class="table table-summary">
                      <tbody>
                        <tr class="summary-subtotal">
                          <td>Subtotal:</td>
                          <td id="subtotalcart">₹0.00</td>
                        </tr>
                        <!-- End .summary-subtotal -->
                        <tr class="summary-shipping">
                          <td>Discount:</td>
                          <td>&nbsp;</td>
                        </tr>

                        <tr class="summary-shipping-row">
                          <td>
                            <div class="custom-control custom-radio">
                              
                              <label
                                class="custom-control-label"
                                for="free-shipping"
                                >Total savings</label
                              >
                            </div>
                            <!-- End .custom-control -->
                          </td>
                          <td id="totaloffer">₹0.00</td>
                        </tr>
                        <!-- End .summary-shipping-row -->

                        <tr class="summary-total">
                          <td>Total:</td>
                          <td id="totalofferprice">₹0.00</td>
                        </tr>
                        <!-- End .summary-total -->
                      </tbody>
                    </table>
                    <!-- End .table table-summary -->
                    

                    <% if (user) { %>
                    <button
                      form="form-checkout"
                      id="checkout-btn"
                      class="btn btn-outline-primary-2 btn-order btn-block"
                      >PROCEED TO CHECKOUT</button
                    >
                    <% } else { %>
                      <button
                      class="btn btn-outline-primary-2 btn-order btn-block"
                      disabled
                      >Login To Proceed</button
                    >
                    <% } %>
                  </div>
                  <!-- End .summary -->

                  <a
                    href="/shop"
                    class="btn btn-outline-dark-2 btn-block mb-3"
                    ><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i
                  ></a>
                </aside>
                <!-- End .col-lg-3 -->
              </div>
              <!-- End .row -->
            </div>
            <!-- End .container -->
          </div>
          <!-- End .cart -->
        </div>
        <!-- End .page-content -->
      </main>
      <!-- End .main -->

    <%- include("./footer.ejs") %>

    <script>
        $("#cart-dropdown").hide();

        function cartpageupdate(){
        let total=0.00;
        let totaloffer=0.00;
        let offer=0.00;
        let errmsg = "<%= errmsg %>";
        let errid = "<%= errid %>";
        let cartcontainer=document.getElementById("cartproductcontainer");
        cartcontainer.innerHTML="";
        if(localStorage.getItem('products')){
            let products=JSON.parse(localStorage.getItem('products'));
            // alert(products);
            products.forEach(function (item) {
                // alert(item.productOffer);
                let totalprice=Number(item.productPrice)-((Number(item.productPrice))*((Number(item.productOffer))/100));
                totaloffer+=totalprice;
                cartcontainer.innerHTML+=`<tr>
                <td class="product-col">
                    <div class="product">
                        <figure class="product-media">
                            <a href="#">
                                <img src="${item.productImage}" alt="Product image">
                            </a>
                        </figure>
                        <div>
                          <h3 class="product-title">
                              <a href="/view/${item.productId}">${item.productName.split("-")[0]}</a>
                          </h3><!-- End .product-title -->
                          <p>${item.productName.split("-")[1]}</p>
                        </div>
                    </div><!-- End .product -->
                </td>
                <td class="price-col">₹${item.productPrice}</td>
                <td class="quantity-col">
                    <div class="cart-product-quantity">
                        <input type="hidden" name="productids" value="${item.productId}">
                        <input type="number" name="quantity" class="form-control" value="1" min="1" max="9" step="1" data-decimals="0" required>
                        <span class="text-danger">${errid === item.productId ? errmsg : ""}</span>
                    </div><!-- End .cart-product-quantity -->                                 
                </td>
                <td class="total-col">₹${totalprice}</td>
                <td class="remove-col"><button productid="${item.productId}" class="removebtncart btn-remove"><i class="icon-close"></i></button></td>
            </tr>`
        })
        if(products.length > 0){
            total = products.map(prod => Number(prod.productPrice)).reduce((acc, amount) => Number(acc) + Number(amount));
        }
        else{
            cartcontainer.innerHTML += `<center><span>No items in the cart yet</span></center>`;
            $("#checkout-btn").hide();
        }
        document.getElementById("subtotalcart").innerText=`₹${total}`;
        document.getElementById("totalofferprice").innerText=`₹${totaloffer}`;
        document.getElementById("totaloffer").innerText=`₹${(total-totaloffer).toFixed(2)}`;
    }
    }
    cartpageupdate();
    
    function updateCart(){
        let products = [];
        let total = 0.00;
        if(localStorage.getItem('products')){
            products=JSON.parse(localStorage.getItem('products'));
            const cart=document.getElementsByClassName("dropdown-cart-products")[0];
            cart.innerHTML='';
            products.forEach(function (item) {
                // copy.push(item + item+2);
                cart.innerHTML+=` <div class="product">
                <div class="product-cart-details">
                    <h4 class="product-title">
                        <a href="/view/${item.productId}">${item.productName}</a>
                    </h4>

                    <span class="cart-product-info">
                        ₹${item.productPrice}                    
                    </span>
                </div><!-- End .product-cart-details -->

                <figure class="product-image-container">
                    <a href="/view/${item.productId}" class="product-image">
                        <img src="${item.productImage}" alt="product">
                    </a>
                </figure>
                <a href="#" productid="${item.productId}" class="btn-remove" title="Remove Product"><i class="icon-close"></i></a>
            </div>`;
            });

            if(products.length > 0){
            total = products.map(prod => Number(prod.productPrice)).reduce((acc, amount) => Number(acc) + Number(amount));
            cart.innerHTML += `<div class="dropdown-cart-total">
                                    <span>Total</span>
                                    <span id="cart-total-price-u" class="cart-total-price">₹ ${total}</span>
                                </div>

                                <div class="dropdown-cart-action">
                                    
                                    <a href="/cart" class="btn btn-outline-primary-2 w-100"><span>View Cart</span><i class="icon-long-arrow-right"></i></a>
                                </div>`;
            
            }else{
                cart.innerHTML += `<center><span>No items in the cart yet</span></center>`;
            }
        }
        $("#cart-count").text(products.length);
        $("#cart-total-text").text("₹" + total);
        
    }


    function removeProduct(productId){
        let storageProducts = JSON.parse(localStorage.getItem('products'));
        let products = storageProducts.filter(product => product.productId !== productId);
        localStorage.setItem('products', JSON.stringify(products));
        updateCart();
    }

    $(document).on('click', '.removebtncart', function(){
        removeProduct($(this).attr("productid"));
        cartpageupdate();
    });
    var pastprice = 0,
        discount = 0,
        newprice = 0,
        pastdiscount = 0,
        newdiscount = 0;
    const $form999 = $('#check-coupon')
    $form999.on('submit', submitHandler999)
    $("#cremove").on("click",()=>{
      $("#cmutton").html("Apply")
      $("#cmutton").attr("type","submit")
      $("#cremove").hide()
      $("#couponid").val("")
      $("#couponresponse").text("")

      $("#totalofferprice").text(`₹${pastprice}`);
      $("#totaloffer").text(`₹${pastdiscount}`);
      $("#couponcode").attr("value", "");
    })
    function submitHandler999 (e) {
        e.preventDefault()
        $.ajax({
            url: '/api/coupon/check',
            type:'POST',
            data: $form999.serialize()
        }).done(response => {
              $("#couponresponse").text(response.message)
              $("#couponresponse").css("color", response.color)
            if(response.success){
              pastprice = Number($("#totalofferprice").text().split("₹")[1])
              discount = (pastprice / 100) * Number(response.discount)
              newprice = pastprice - discount
              $("#totalofferprice").text(`₹${newprice}`);
              $("#cmutton").html("Applied")
              $("#cmutton").attr("type","button")
              $("#cremove").show()
              pastdiscount = Number($("#totaloffer").text().split("₹")[1])
              newdiscount = pastdiscount + discount
              $("#totaloffer").text(`₹${newdiscount}`)
              $("#couponcode").attr("value", response.coupon)
            }
        })
    }
    </script>
  </body>
</html>
